{
  "name": "articlegen_airtable",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "article-generator",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "f96858e3-e9c1-4645-a262-af138298a126",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2656,
        -1232
      ],
      "webhookId": "f89c1d5f-2b92-4754-a227-92d20b48eee3"
    },
    {
      "parameters": {
        "jsCode": "// Parse URL-encoded form data\nif ($input.item.json.body && typeof $input.item.json.body === 'object') {\n    // Data is already parsed (likely from test execution)\n    return $input.item.json;\n} else {\n    // Parse the raw body for actual webhook calls\n    const parsedBody = {};\n    const body = $input.item.json.body || '';\n    \n    body.split('&').forEach(pair => {\n        const [key, value] = pair.split('=');\n        parsedBody[key] = decodeURIComponent(value || '');\n    });\n    \n    return {\n        ...$input.item.json,\n        body: parsedBody\n    };\n}"
      },
      "id": "bdff8acf-1e16-4276-a515-e55b755c607d",
      "name": "Parse Form Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2432,
        -1232
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "condition1",
              "leftValue": "={{ $json.body && $json.body.prompt }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "condition2",
              "leftValue": "={{ parseInt($json.body.wordCount) }}",
              "rightValue": 100,
              "operator": {
                "type": "number",
                "operation": "largerEqual"
              }
            },
            {
              "id": "condition3",
              "leftValue": "={{ parseInt($json.body.wordCount) }}",
              "rightValue": 1500,
              "operator": {
                "type": "number",
                "operation": "smallerEqual"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ab57e862-fb78-4628-8cf4-1b1060c18061",
      "name": "Check Form Data",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2656,
        160
      ]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "<!DOCTYPE html>\n<html>\n<head>\n    <title>AI Article Generator</title>\n    <style>\n        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 700px; margin: 50px auto; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }\n        .form-container { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }\n        h1 { color: #333; text-align: center; margin-bottom: 10px; font-size: 2.5em; }\n        .subtitle { color: #666; text-align: center; margin-bottom: 30px; font-size: 1.1em; }\n        .form-group { margin-bottom: 25px; }\n        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; font-size: 1.1em; }\n        input, textarea { width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; box-sizing: border-box; }\n        input:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }\n        textarea { height: 120px; resize: vertical; font-family: inherit; }\n        button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: 600; width: 100%; transition: transform 0.2s; }\n        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }\n        button:active { transform: translateY(0); }\n        .required { color: #e74c3c; }\n        .loading { display: none; text-align: center; margin-top: 20px; }\n        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }\n        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }\n        .error { color: #e74c3c; margin-top: 10px; }\n    </style>\n</head>\n<body>\n    <div class=\"form-container\">\n        <h1>ðŸ¤– AI Article Generator</h1>\n        <p class=\"subtitle\">Generate high-quality articles with AI detection and automatic publishing</p>\n        <form id=\"articleForm\" method=\"POST\">\n            <div class=\"form-group\">\n                <label for=\"prompt\">Article Prompt <span class=\"required\">*</span></label>\n                <textarea name=\"prompt\" id=\"prompt\" required placeholder=\"Enter your detailed article prompt. For example: 'Act as a copywriter for a health company. Write persuasive content about custom vegan diet plans that help people lose weight naturally...'\"></textarea>\n            </div>\n            <div class=\"form-group\">\n                <label for=\"wordCount\">Target Word Count <span class=\"required\">*</span></label>\n                <input type=\"number\" name=\"wordCount\" id=\"wordCount\" required placeholder=\"1000\" min=\"100\" max=\"5000\">\n                <div id=\"wordCountError\" class=\"error\" style=\"display: none;\">Word count must be between 100 and 5000</div>\n            </div>\n            <div class=\"form-group\">\n                <label for=\"tone\">Writing Tone & Style</label>\n                <input type=\"text\" name=\"tone\" id=\"tone\" placeholder=\"professional, casual, technical, persuasive, friendly (optional - defaults to professional)\">\n            </div>\n            <button type=\"submit\" id=\"submitBtn\">Generate Article âœ¨</button>\n            <div class=\"loading\" id=\"loading\">\n                <div class=\"spinner\"></div>\n                <p>Generating your article... This may take a few minutes.</p>\n            </div>\n        </form>\n    </div>\n    <script>\n        document.getElementById('articleForm').addEventListener('submit', function(e) {\n            const wordCount = parseInt(document.getElementById('wordCount').value);\n            const errorElement = document.getElementById('wordCountError');\n            \n            if (wordCount < 100 || wordCount > 5000) {\n                e.preventDefault();\n                errorElement.style.display = 'block';\n                return false;\n            } else {\n                errorElement.style.display = 'none';\n                document.getElementById('submitBtn').style.display = 'none';\n                document.getElementById('loading').style.display = 'block';\n            }\n        });\n    </script>\n</body>\n</html>",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "text/html"
              }
            ]
          }
        }
      },
      "id": "0b35ff54-593e-42fa-8c11-18365f2cc2ea",
      "name": "Show Form",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2208,
        -1232
      ]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "<!DOCTYPE html>\n<html>\n<head>\n    <title>Validation Error</title>\n    <style>\n        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }\n        .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }\n        h1 { color: #e74c3c; text-align: center; margin-bottom: 20px; }\n        .error-message { background: #fdecea; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #e74c3c; }\n        .actions { text-align: center; margin-top: 30px; }\n        .btn { display: inline-block; padding: 12px 24px; margin: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: transform 0.2s; }\n        .btn:hover { transform: translateY(-2px); }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <h1>âš ï¸ Validation Error</h1>\n        <div class=\"error-message\">\n            <p>Please provide both a prompt and a valid word count (between 100 and 5000 words).</p>\n        </div>\n        <div class=\"actions\">\n            <a href=\"/webhook/article-generator\" class=\"btn\">Try Again</a>\n        </div>\n    </div>\n</body>\n</html>",
        "options": {
          "responseCode": 400,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "text/html"
              }
            ]
          }
        }
      },
      "id": "151853aa-530d-48e6-aae8-7e71a9e02db0",
      "name": "Validation Error Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2656,
        -288
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1b2c3d4",
              "name": "prompt",
              "value": "={{ $json.body.prompt }}",
              "type": "string"
            },
            {
              "id": "e5f6g7h8",
              "name": "wordCount",
              "value": "={{ parseInt($json.body.wordCount) }}",
              "type": "number"
            },
            {
              "id": "i9j0k1l2",
              "name": "tone",
              "value": "={{ $json.body.tone || 'professional' }}",
              "type": "string"
            },
            {
              "id": "m3n4o5p6",
              "name": "rewriteAttempts",
              "value": 0,
              "type": "number"
            },
            {
              "id": "q7r8s9t0",
              "name": "maxAttempts",
              "value": 3,
              "type": "number"
            },
            {
              "id": "u1v2w3x4",
              "name": "targetAIScore",
              "value": 10,
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "2a66f76f-087f-45b9-92e9-9d49994e96fe",
      "name": "Initialize Variables",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2208,
        -1040
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4-turbo",
          "mode": "list",
          "cachedResultName": "GPT-4-Turbo"
        },
        "messages": {
          "values": [
            {
              "content": "=\"Write a comprehensive article on the following topic:\\n\\nTopic: ={{ $json.prompt }}\\nTarget Word Count: ={{ $json.wordCount }} words\\nTone/Style: ={{ $json.tone }}\\n\\n**Formatting Requirements:**\\n1. # [Catchy Headline in H1]\\n2. [Engaging introduction paragraph]\\n3. ## [Main Section Heading in H2]\\n4. [Content paragraph]\\n5. ### [Subsection in H3 if needed]\\n6. [Content paragraph]\\n7. - Use bullet points for lists\\n8. - Like this example\\n9. ## [Another Main Section in H2]\\n10. [More content]\\n11. # Conclusion\\n12. [Summary of key points]\\n\\nProvide the output in this exact JSON format:\\n{\\n  \\\"title\\\": \\\"Article Title\\\",\\n  \\\"content\\\": \\\"Full article content with Markdown formatting\\\"}\""
            }
          ]
        },
        "jsonOutput": true,
        "options": {
          "maxTokens": "={{ Math.min($json.wordCount * 1.5, 4000) }}",
          "temperature": 0.7
        }
      },
      "id": "073d69e9-803b-4434-af85-26d382e22faa",
      "name": "Generate Initial Article",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.5,
      "position": [
        -1984,
        -1040
      ],
      "credentials": {
        "openAiApi": {
          "id": "2nipFUqTLSnWySli",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// N8N JavaScript Code for Parse Article Node\n// This code transforms the input JSON array to the required output format\n\n// Get the input data from n8n\nconst inputData = $input.all();\n\n// Process each item in the input array\nconst outputData = inputData.map(item => {\n  // The input data structure: item.json contains the array\n  // Extract the first item from the array\n  const dataArray = Array.isArray(item.json) ? item.json : [item.json];\n  const firstItem = dataArray[0];\n  \n  // Extract the content from the message\n  const content = firstItem.message.content;\n  \n  // Extract title using regex since the content might be incomplete JSON\n  let extractedTitle = \"Unknown Article\"; // Fallback title\n  \n  // Use regex to find the title field in the JSON-like string\n  const titleMatch = content.match(/\"title\":\\s*\"([^\"]+)\"/);\n  if (titleMatch && titleMatch[1]) {\n    extractedTitle = titleMatch[1];\n  }\n  \n  // Create the output structure\n  const result = {\n    article: {\n      title: extractedTitle,\n      content: content\n    },\n    currentContent: content,\n    title: extractedTitle,\n    rewriteAttempts: $node['Initialize Variables'].json.rewriteAttempts,\n    debug: {\n      rawResponse: firstItem\n    }\n  };\n  \n  return {\n    json: result\n  };\n});\n\n// Return the processed data\nreturn outputData;"
      },
      "id": "69d11580-1e14-4dfc-b591-128e8814f198",
      "name": "Parse Article",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1632,
        -1040
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.sapling.ai/api/v1/aidetect",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "={{ $json['requestPayload'].key }}"
            },
            {
              "name": "text",
              "value": "={{ $json['requestPayload'].text }}"
            },
            {
              "name": "sent_scores",
              "value": "={{ $json['requestPayload'].sent_scores }}"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "555f1eff-3c87-48f7-a9c6-a26f7f81588a",
      "name": "Check AI Detection Score",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1184,
        -1040
      ],
      "code": "// Validate content length and topic\nconst content = $input.item.json.currentContent;\n\n// Check if content is empty or malformed\nif (!content || content.trim().length === 0) {\n    throw new Error('Invalid content passed to AI Detection or Rewrite.');\n}\n\n// Check if content contains the correct topic (vegan diet or related terms)\nconst topicKeywords = ['vegan', 'plant-based', 'weight loss']; // Add relevant keywords from the original prompt\nconst containsTopic = topicKeywords.some(keyword => content.toLowerCase().includes(keyword.toLowerCase()));\n\nif (!containsTopic) {\n    throw new Error('Topic mismatch detected. The rewritten article strayed off the topic.');\n}\n\n// Clean content for the Sapling API request\nlet cleanContent = content.replace(/[\\u0000-\\u0008\\u000B\\u000C\\u000E-\\u001F\\u007F]/g, '').trim();\n\n// Prepare Sapling API request payload\nconst requestPayload = {\n    key: 'YOUR_SAPLING_API_KEY',  // Replace with actual API key or environment variable\n    text: cleanContent,\n    sent_scores: true\n};\n\nreturn {\n    ...$input.item.json,\n    requestPayload: requestPayload,\n    cleanContent: cleanContent\n};",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "k7l8m9n0",
              "name": "aiScore",
              "value": "={{ $json.score ? $json.score * 100 : 0 }}",
              "type": "number"
            },
            {
              "id": "o1p2q3r4",
              "name": "needsRewrite",
              "value": "={{ ($json.score ? ($json.score * 100) : 0) > $node['Initialize Variables'].json.targetAIScore }}",
              "type": "boolean"
            },
            {
              "id": "s5t6u7v8",
              "name": "currentContent",
              "value": "={{ $node['Parse Article'].json.currentContent }}",
              "type": "string"
            },
            {
              "id": "w9x0y1z2",
              "name": "title",
              "value": "={{ $node['Parse Article'].json.title }}",
              "type": "string"
            },
            {
              "id": "a3b4c5d6",
              "name": "rewriteAttempts",
              "value": "={{ $node['Parse Article'].json.rewriteAttempts }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "06dc6997-d8e0-409d-b369-43027f3bd6c0",
      "name": "Process AI Score",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -960,
        -1232
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "condition1",
              "leftValue": "={{ $json.needsRewrite }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            },
            {
              "id": "condition2",
              "leftValue": "={{ $json.rewriteAttempts }}",
              "rightValue": "={{ $node['Initialize Variables'].json.maxAttempts }}",
              "operator": {
                "type": "number",
                "operation": "smaller"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "667ece9a-f35c-4a1a-a7ca-eabb4c192d46",
      "name": "Check If Needs Rewrite",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -736,
        -1232
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4-turbo",
          "mode": "list",
          "cachedResultName": "GPT-4-Turbo"
        },
        "messages": {
          "values": [
            {
              "content": "=You are an expert content editor specializing in making AI-generated content indistinguishable from human writing. The article below has an AI detection score of {{ $json.aiScore }}% and needs to be rewritten to sound more naturally human while maintaining its core message and quality.\n\n**IMPORTANT INSTRUCTIONS (NON-NEGOTIABLE)**:\n1. **Do not change the topic** of the article. The topic must remain exactly as stated: **{{ $node['Initialize Variables'].json.prompt }}**. If you are unsure, do not deviate from the original topic. The AI detection will fail if the topic is changed.\n2. **Do not introduce new subjects or unrelated themes**.\n3. **If the topic is unclear, ask for clarification** instead of assuming or changing it. If clarification is not provided, **reject the request** by responding with: `{\"error\": \"TOPIC_DRIFT\"}`.\n4. **Maintain the same factual content**. Do not alter any facts, product names, or details.\n5. **Avoid excessive creativity**: Focus on making the article sound more natural without introducing irrelevant creativity. The AI should focus on **natural sentence variations** without distorting the core message.\n\n**REWRITING GUIDELINES**:\n1. **Sentence Variation**: Mix short punchy sentences with longer, complex ones. Avoid repetitive patterns.\n2. **Personal Touch**: Add subtle personal insights, opinions, or \"in my experience\" type statements where appropriate.\n3. **Natural Flow**: Use transitional phrases that humans naturally use (e.g., \"That said...\", \"Here's the thing...\", \"What's interesting is...\").\n4. **Imperfect Structure**: Occasionally break formal writing rules naturally (start sentences with \"And\" or \"But\" when it feels right).\n5. **Conversational Elements**: Include rhetorical questions, direct reader address, or casual asides.\n6. **Authentic Voice**: Make it sound like it's written by someone with real expertise and genuine passion for the topic.\n7. **Subtle Inconsistencies**: Add minor stylistic variations that humans naturally have.\n8. **Emotional Resonance**: Include subtle emotional cues that show the writer cares about the reader's success.\n\n**MAINTAIN THESE ELEMENTS**:\n- Proper Markdown formatting (H1, H2, H3 headings, bullet points).\n- Same approximate word count ({{ $node['Initialize Variables'].json.wordCount }} words).\n- Core message and valuable information.\n- Target audience appropriateness from original context.\n- Professional quality and credibility.\n- The article's original purpose and intent.\n\n**ORIGINAL ARTICLE TO REWRITE**:\nTitle: {{ $json.title }}\nContent: {{ $json.currentContent }}\n\nRewrite this to sound like it was written by a human expert who genuinely cares about the topic and the reader's success. Make it engaging, authentic, and naturally imperfect while keeping all the valuable information intact. The goal is to reduce the AI detection score significantly while improving readability and engagement.\n\nProvide the output in the following format:\n{\n  \"title\": \"Rewritten Title (same topic)\",\n  \"content\": \"Rewritten content in Markdown format\"\n}"
            }
          ]
        },
        "jsonOutput": true,
        "options": {
          "temperature": 0.3
        }
      },
      "id": "85a91c4a-ecf0-410e-a6e4-861747b843b3",
      "name": "Rewrite Article",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.5,
      "position": [
        -512,
        -1328
      ],
      "credentials": {
        "openAiApi": {
          "id": "2nipFUqTLSnWySli",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "v5w6x7y8",
              "name": "currentContent",
              "value": "={{ $node['Rewrite Article'].json.content || $node['Process AI Score'].json.currentContent }}",
              "type": "string"
            },
            {
              "id": "z9a0b1c2",
              "name": "title",
              "value": "={{ $node['Rewrite Article'].json.title || $node['Process AI Score'].json.title }}",
              "type": "string"
            },
            {
              "id": "d3e4f5g6",
              "name": "rewriteAttempts",
              "value": "={{ ($node['Process AI Score'].json.rewriteAttempts || 0) + 1 }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "55ec1b01-cb02-4f6f-9ed9-5b42e26b3e8a",
      "name": "Update After Rewrite",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -160,
        -1152
      ]
    },
    {
      "parameters": {
        "jsCode": "// Count words in the content\nconst content = $input.item.json.currentContent;\nconst wordCount = content ? content.trim().split(/\\s+/).length : 0;\n\n// Get original prompt and other data\nconst originalPrompt = $node['Initialize Variables'].json.prompt;\nconst aiScore = $input.item.json.aiScore || 0;\nconst rewriteAttempts = $input.item.json.rewriteAttempts || 0;\n\nreturn {\n  title: $input.item.json.title,\n  content: content,\n  wordCount: wordCount,\n  aiScore: aiScore,\n  originalPrompt: originalPrompt,\n  rewriteAttempts: rewriteAttempts,\n  creationDate: new Date().toISOString()\n};"
      },
      "id": "88a84d6c-6111-48fc-8e47-c63695f84592",
      "name": "Prepare Airtable Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -448,
        -1136
      ]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "=<!DOCTYPE html>\n<html>\n<head>\n    <title>Article Generation Complete</title>\n    <style>\n        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }\n        .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }\n        h1 { color: #333; text-align: center; margin-bottom: 20px; }\n        .success { color: #27ae60; font-weight: bold; font-size: 1.2em; text-align: center; margin-bottom: 30px; }\n        .info { background: linear-gradient(135deg, #667eea15, #764ba215); padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #667eea; }\n        .metric { display: inline-block; margin-right: 30px; margin-bottom: 10px; }\n        .label { font-weight: bold; color: #666; }\n        .value { color: #333; font-size: 1.1em; }\n        .actions { text-align: center; margin-top: 30px; }\n        .btn { display: inline-block; padding: 12px 24px; margin: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: transform 0.2s; }\n        .btn:hover { transform: translateY(-2px); }\n        .title-display { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; font-style: italic; }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <h1>âœ… Article Successfully Generated!</h1>\n        <p class=\"success\">Your article has been created and saved to Airtable!</p>\n        \n        <div class=\"title-display\">\n            <strong>Article Title:</strong> {{ $json.title }}\n        </div>\n        \n        <div class=\"info\">\n            <div class=\"metric\">\n                <span class=\"label\">Word Count:</span>\n                <span class=\"value\">{{ $json.wordCount }}</span>\n            </div>\n            <div class=\"metric\">\n                <span class=\"label\">AI Detection Score:</span>\n                <span class=\"value\">{{ $json.aiScore }}%</span>\n            </div>\n            <div class=\"metric\">\n                <span class=\"label\">Rewrite Attempts:</span>\n                <span class=\"value\">{{ $json.rewriteAttempts }}</span>\n            </div>\n        </div>\n        \n        <div class=\"actions\">\n            <a href=\"/webhook/article-generator\" class=\"btn\">Generate Another Article</a>\n        </div>\n    </div>\n</body>\n</html>",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "text/html"
              }
            ]
          }
        }
      },
      "id": "5a19cfaa-cfd3-447a-9d55-ab5d37ca917c",
      "name": "Success Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        112,
        -928
      ]
    },
    {
      "parameters": {
        "operation": "create",
        "base": {
          "__rl": true,
          "value": "appVHyWpZjm1GLoKz",
          "mode": "list",
          "cachedResultName": "ArticleStore",
          "cachedResultUrl": "https://airtable.com/appVHyWpZjm1GLoKz"
        },
        "table": {
          "__rl": true,
          "value": "tblkudiRSoJwf4Q4F",
          "mode": "list",
          "cachedResultName": "Articles",
          "cachedResultUrl": "https://airtable.com/appVHyWpZjm1GLoKz/tblkudiRSoJwf4Q4F"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Title": "\"={{ $json.title }}\"",
            "Content": "\"={{ $json.content }}\"",
            "AI Score": "=\"={{ $json.aiScore }}\"",
            "Word Count": "=\"={{ $json.wordCount }}\"",
            "Original Prompt": "\"={{ $json.originalPrompt }}\"",
            "Rewrite Attempts": "=\"={{ $json.rewriteAttempts }}\"",
            "Creation Date": "=\"={{ $json.creationDate }}\""
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Title",
              "displayName": "Title",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Content",
              "displayName": "Content",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Word Count",
              "displayName": "Word Count",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "AI Score",
              "displayName": "AI Score",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Original Prompt",
              "displayName": "Original Prompt",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Rewrite Attempts",
              "displayName": "Rewrite Attempts",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Creation Date",
              "displayName": "Creation Date",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        -160,
        -928
      ],
      "id": "17d3e2d7-4114-4b25-a358-405a29a8ab7a",
      "name": "Save to Airtable",
      "credentials": {
        "airtableTokenApi": {
          "id": "lsSVzmWHf9W8pVYi",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "<!DOCTYPE html>\n<html>\n<head>\n    <title>Error Generating Article</title>\n    <style>\n        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }\n        .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }\n        h1 { color: #e74c3c; text-align: center; margin-bottom: 20px; }\n        .error-message { background: #fdecea; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #e74c3c; }\n        .actions { text-align: center; margin-top: 30px; }\n        .btn { display: inline-block; padding: 12px 24px; margin: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: transform 0.2s; }\n        .btn:hover { transform: translateY(-2px); }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <h1>âš ï¸ Error Generating Article</h1>\n        <div class=\"error-message\">\n            <p>We encountered an error while generating your article. Please try again later.</p>\n            <p>Error details: {{ $json.error }}</p>\n        </div>\n        <div class=\"actions\">\n            <a href=\"/webhook/article-generator\" class=\"btn\">Try Again</a>\n        </div>\n    </div>\n</body>\n</html>",
        "options": {
          "responseCode": 500,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "text/html"
              }
            ]
          }
        }
      },
      "id": "80af61cd-7348-4265-9a8a-8cd1dc334e36",
      "name": "Error Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2656,
        -512
      ]
    },
    {
      "parameters": {
        "errorMessage": "Sapling AI detection service error!"
      },
      "id": "d106d266-7b3f-481f-baaf-46db9d5c0bae",
      "name": "AI Detection Error",
      "type": "n8n-nodes-base.stopAndError",
      "typeVersion": 1,
      "position": [
        -960,
        -912
      ]
    },
    {
      "parameters": {
        "errorMessage": "Content parsing failed - unable to extract article content from OpenAI response. Please check the OpenAI model configuration and JSON output setting."
      },
      "id": "c5f369e9-e945-43bc-83f9-d42ca00bda2b",
      "name": "Content Parse Error",
      "type": "n8n-nodes-base.stopAndError",
      "typeVersion": 1,
      "position": [
        -2432,
        -736
      ]
    },
    {
      "parameters": {
        "errorMessage": "Airtable Error!"
      },
      "id": "3aabd1b3-0230-4ca2-8c90-d4a0885bbef7",
      "name": "Airtable Error",
      "type": "n8n-nodes-base.stopAndError",
      "typeVersion": 1,
      "position": [
        -2656,
        -64
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "condition1",
              "leftValue": "={{ $json.currentContent }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "condition2",
              "leftValue": "={{ $json.currentContent }}",
              "rightValue": {},
              "operator": {
                "type": "object",
                "operation": "notEqual"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "id": "98a086b6-1ecb-4089-a128-07ba7703bdb7",
      "name": "Check Content Valid",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2656,
        -736
      ]
    },
    {
      "parameters": {
        "jsCode": "// Prepare Sapling API request data\nconst content = $input.item.json.currentContent;\n\n// Your Sapling API key - replace with your actual key\nconst SAPLING_API_KEY = \"CP6OJC4Q7B0CLWYDVZ5PP18KPTOVT83Q\";\n\n// Validate content\nif (!content || typeof content !== 'string' || content.trim().length === 0) {\n    throw new Error('No valid content available for AI detection');\n}\n\n// Clean and prepare the content (limit to 200k characters as per Sapling API)\nlet cleanContent = content\n    .replace(/[\\u0000-\\u0008\\u000B\\u000C\\u000E-\\u001F\\u007F]/g, '') // Remove control characters\n    .trim();\n\n// Limit content length (Sapling API has 200k character limit)\nif (cleanContent.length > 200000) {\n    cleanContent = cleanContent.substring(0, 200000);\n}\n\n// Prepare the request payload\nconst requestPayload = {\n    key: SAPLING_API_KEY,\n    text: cleanContent,\n    sent_scores: true\n};\n\nconsole.log('Preparing Sapling request for content length:', cleanContent.length);\n\nreturn {\n    // Pass through all existing data\n    ...($input.item.json),\n    // Add new fields for the API request\n    requestPayload: requestPayload,\n    requestPayloadString: JSON.stringify(requestPayload),\n    cleanContent: cleanContent\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1408,
        -1040
      ],
      "id": "f4c23851-d87a-4831-8732-06291b188875",
      "name": "Prepare Sapling Request"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Parse Form Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Form Data": {
      "main": [
        [
          {
            "node": "Show Form",
            "type": "main",
            "index": 0
          },
          {
            "node": "Initialize Variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Initialize Variables": {
      "main": [
        [
          {
            "node": "Generate Initial Article",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Initial Article": {
      "main": [
        [
          {
            "node": "Parse Article",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Article": {
      "main": [
        [
          {
            "node": "Prepare Sapling Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Content Valid": {
      "main": [
        [],
        [
          {
            "node": "Content Parse Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check AI Detection Score": {
      "main": [
        [
          {
            "node": "Process AI Score",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Detection Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process AI Score": {
      "main": [
        [
          {
            "node": "Check If Needs Rewrite",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check If Needs Rewrite": {
      "main": [
        [
          {
            "node": "Prepare Airtable Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Rewrite Article",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rewrite Article": {
      "main": [
        [
          {
            "node": "Update After Rewrite",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update After Rewrite": {
      "main": [
        [
          {
            "node": "Check AI Detection Score",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Airtable Data": {
      "main": [
        [
          {
            "node": "Save to Airtable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Airtable": {
      "main": [
        [
          {
            "node": "Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Sapling Request": {
      "main": [
        [
          {
            "node": "Check AI Detection Score",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "ae0c80cd-a139-4190-8f1a-16f162029578",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "78ce5a5377274f9298837c1f5755493b7a72f2a100b80c779f56af39bf59618a"
  },
  "id": "Bf9AGXIu0FuqaKac",
  "tags": []
}
